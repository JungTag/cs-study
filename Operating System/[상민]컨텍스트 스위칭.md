# CS스터디 - 운영체제

## 컨텍스트 스위칭(Context Switching)

<img width="510" alt="스크린샷 2021-06-06 오전 11 01 53" src="https://user-images.githubusercontent.com/61453718/120910073-a2a4f800-c6b6-11eb-845f-0a822278bb25.png">

출처: [컨텍스트 스위칭](https://www.crocus.co.kr/1364)

컨텍스트 스위칭이란, 멀티 프로세서 환경에서 CPU가 어떤 하나의 프로세스를 실행하고 있는 상태에서 인터럽트 요청에 의해 다음 우선순위의 프로세스가 실행되어야 할 때 기존의 프로세스의 상태 또는 레지스터 값(Context)을 저장(보관)하고 CPU가 다음 프로세스를 수행하도록 새로운 프로세스의 상태 또는 레지스터 값을 **교체**하는 작업을 말한다.

이 컨텍스트 스위칭을 통해 우리는 멀티 프로세싱, 멀티 스레딩을 운영할 수 있다.

### 컨텍스트(Context)

여러가지 의미가 있지만, OS에서 컨텍스트는 **CPU가 해당 프로세스를 실행하기 위한, 해당 프로세스의 정보들**을 의미한다. 그리고 이 컨텍스트들은 프로세스의 PCB(Process Control Block)에 저장된다.

컨텍스트 스위칭을 할 때 이 PCB에서 정보를 읽어와서, 이전에 수행하던 일(현재는 중단되어있는 일)을 CPU가 이어서 수행할 수 있는 것이다.

### PCB

![image](https://user-images.githubusercontent.com/61453718/120910362-41325880-c6b9-11eb-842b-dd05eea63fc9.png)

출처: [PCB와 스레드](https://blog.naver.com/chanheeis/221269778250)

PCB(프로세스 제어 블록, Process Control Block)는 위에서 말했듯, 컨텍스트가 저장되는 저장소라고 생각하면 된다. PCB는 다음의 요소들이 저장된다.

    1. 프로세스 상태: 생성, 준비, 수행, 대기 ,중지
    2. 프로그램 카운터: 프로세스가 다음에 실행할 명령어 주소
    3. 레지스터: 누산기, 스택, 색인 레지스터
    4. 프로세스 번호

이 PCB에 정보를 저장하고, 또는 가져올 때 컨텍스트 스위칭의 단점이 존재한다.
이 과정 동안에 CPU는 아무런 일도 할 수 없기 때문이다. 그래서, 컨텍스트 스위칭이 너무 잦으면 성능이 떨어지게 된다.

### 인터럽트

인터럽트는, CPU가 프로그램을 실행하고 있을 때 실행중인 프로그램 밖에서 예외 상황이 발생하여 처리가 필요한 경우 CPU에게 알려 예외 상황을 처리할 수 있도록 하는 것을 말한다.

이 인터럽트가 발생할 때, 컨텍스트 스위칭이 일어나는 것이다.
컨텍스트 스위칭을 발생시키는 인터럽트 요청은 다음과 같은 것들이 대표적이다:

    1. I/O 요청
    2. CPU 사용시간 만료 (time slice expired)
    3. 자식 프로세스 생성 시 (fork a child)

이러한 인터럽트 요청이 발생할 때, 컨텍스트 스위칭의 주체인 **스케줄러**가 우선 순위 알고리즘에 따라 다음 번째의 프로세스를 결정하게 된다.

## 정리

위 사진을 다시 보며 컨텍스트 스위칭의 과정을 정리해 보자.

1. P0의 프로세스가 실행 중에 P1에 대한 인터럽트 요청이 들어온다.
2. 그에 따라 P0을 중단시키고 PCB에 지금까지의 P0의 상태를 담는다.
3. PCB에서 P1의 정보를 가져온다.
   - 2번과 3번을 하는 동안 CPU는 아무것도 하지 못하기 때문에 정상적으로 정보를 받아 올 때까지 P1은 대기 상태이다. 이 과정이 잦으면 오버헤드가 발생하여 성능이 떨어진다.
4. PCB로부터 정보를 다 받아 오면 CPU는 P1 프로세스를 실행한다.
5. P1의 프로세스가 실행 중에 P0에 대한 인터럽트 요청이 들어온다.
6. 2부터 다시 반복

이렇게, P0과 P1이 서로 대기와 실행을 번갈아가며 하는 과정을 컨텍스트 스위칭이라고 한다. 프로세스가 여러 개일 경우 우선순위 알고리즘에 따라 스케줄러가 결정한다.

### 참조

[컨텍스트 스위칭](https://www.crocus.co.kr/1364)<br />
[OS - Context Switch(컨텍스트 스위치)가 무엇인가?](https://jeong-pro.tistory.com/93)
